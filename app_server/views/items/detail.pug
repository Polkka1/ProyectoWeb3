extends ../layout

block content
  .container.my-4
    if !item
      .alert.alert-danger No se encontró el producto.
    else
      .row.g-4
        .col-md-6
          if item.images && item.images.length
            // Carousel
            #itemCarousel.carousel.slide(data-bs-ride="carousel")
              .carousel-indicators
                each img, idx in item.images
                  button(type="button", data-bs-target="#itemCarousel", data-bs-slide-to=idx, class=idx===0 ? 'active' : '', aria-current=idx===0 ? 'true' : 'false', aria-label=`Slide ${idx+1}`)
              .carousel-inner
                each img, idx in item.images
                  .carousel-item(class=idx===0 ? 'active' : '')
                    img.d-block.w-100(src=img, alt=`${item.title} ${idx+1}`)
              button.carousel-control-prev(type="button", data-bs-target="#itemCarousel", data-bs-slide="prev")
                span.carousel-control-prev-icon(aria-hidden="true")
                span.visually-hidden Previous
              button.carousel-control-next(type="button", data-bs-target="#itemCarousel", data-bs-slide="next")
                span.carousel-control-next-icon(aria-hidden="true")
                span.visually-hidden Next
          else
            img.img-fluid.rounded(src='https://picsum.photos/800/500?grayscale', alt='placeholder')
        .col-md-6
          h2.fw-bold.mb-2= item.title
          .text-muted.mb-3
            span.me-3
              i.bi.bi-tag
              |  #{item.category}
            span
              i.bi.bi-star
              |  #{item.condition}
          h3.text-primary.fw-bold.mb-3 $#{item.price}
          
          // Seller Information
          .card.mb-3.border-0.bg-light
            .card-body
              h6.card-subtitle.mb-2.text-muted Vendedor
              .d-flex.align-items-center
                .bg-primary.rounded-circle.d-flex.align-items-center.justify-content-center.me-3(style="width: 45px; height: 45px;")
                  i.bi.bi-person.text-white.fs-5
                div
                  .fw-bold= item.seller ? (item.seller.firstName || item.seller.name) : (item.sellerName || 'Usuario')
                  // 5-star rating display
                  if item.seller && item.seller.rating
                    .mb-1
                      - const rating = item.seller.rating.average || 0
                      - const fullStars = Math.floor(rating)
                      - const hasHalfStar = rating % 1 >= 0.5
                      - const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0)
                      span.text-warning
                        each star in Array(fullStars)
                          i.bi.bi-star-fill
                        if hasHalfStar
                          i.bi.bi-star-half
                        each star in Array(emptyStars)
                          i.bi.bi-star
                      span.text-muted.ms-2.small
                        if item.seller.rating.totalReviews > 0
                          | (#{item.seller.rating.totalReviews} #{item.seller.rating.totalReviews === 1 ? 'reseña' : 'reseñas'})
                        else
                          | (Sin reseñas)
                  else
                    small.text-muted Sin calificaciones aún
          
          // Favorite button
          .mb-3
            button.btn.btn-outline-danger(onclick=`addToFavorites(${item.itemId}, '${item.title.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', ${item.price}, ${item.sellerId}, '${item.sellerName ? item.sellerName.replace(/'/g, "\\'").replace(/"/g, '&quot;') : 'Vendedor'}')`)
              i.bi.bi-heart.me-2
              | Agregar a Favoritos
          
          if item.description
            p.mb-4= item.description
          
          // Contact Actions
          h6.mb-2 Contactar al vendedor
          .d-grid.gap-2.mb-3
            // In-app messaging button
            a.btn.btn-primary(href=`/messages/new?sellerId=${item.sellerId}&itemId=${item._id}`, onclick=`trackContact('${item._id}')`)
              i.bi.bi-chat-dots.me-2
              | Enviar Mensaje
            
            if item.whatsapp || (item.seller && item.seller.whatsapp)
              a.btn.btn-success(href=`https://wa.me/${item.whatsapp || item.seller.whatsapp}?text=Hola!%20Estoy%20interesado%20en%20tu%20${encodeURIComponent(item.title)}`, target="_blank", onclick=`trackContact('${item._id}')`)
                i.bi.bi-whatsapp.me-2
                | Contactar por WhatsApp
          
          a.btn.btn-outline-secondary(href='/items')
            i.bi.bi-arrow-left.me-2
            | Volver a la lista
          if item.isAvailable === false
            .mt-3.alert.alert-secondary(role='alert')
              i.bi.bi-info-circle.me-2
              | Este producto está marcado como no disponible.

      // Metadata
      .mt-4.text-muted.small
        span.me-3 ID: #{item.itemId || item._id}
        if item.created
          span Publicado: #{new Date(item.created).toLocaleDateString()}

  // JavaScript for favorites
  script.
    async function addToFavorites(itemId, itemTitle, itemPrice, sellerId, sellerName) {
      if (!itemId) {
        alert('Error: Item no válido');
        return;
      }
      
      try {
        const response = await fetch('/api/watchlist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            itemId: itemId,
            itemTitle: itemTitle,
            itemPrice: itemPrice,
            sellerId: sellerId,
            sellerName: sellerName
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('✓ Agregado a favoritos');
          // Optionally redirect to favorites
          if (confirm('¿Ver tus favoritos?')) {
            window.location.href = '/me/favorites';
          }
        } else if (response.status === 401) {
          if (confirm('Debes iniciar sesión para guardar favoritos. ¿Ir a login?')) {
            window.location.href = '/auth/login?returnTo=' + encodeURIComponent(window.location.pathname);
          }
        } else if (response.status === 409) {
          alert('Este item ya está en tus favoritos');
          if (confirm('¿Ver tus favoritos?')) {
            window.location.href = '/me/favorites';
          }
        } else {
          alert('Error: ' + (data.message || 'No se pudo agregar a favoritos'));
        }
      } catch (err) {
        console.error('Error adding to favorites:', err);
        alert('Error de red. Intenta de nuevo.');
      }
    }
    
    // Track contact clicks
    function trackContact(itemId) {
      fetch(`/api/items/${itemId}/contact`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      }).catch(err => {
        console.error('Error tracking contact:', err);
      });
    }
