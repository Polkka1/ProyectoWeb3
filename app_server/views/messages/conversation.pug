extends ../layout

block content
  .container.my-5
    .row.justify-content-center
      .col-lg-8
        // Header
        .card.mb-3
          .card-body.d-flex.justify-content-between.align-items-center
            div
              h4.mb-0
                i.bi.bi-chat-dots.me-2
                | Conversaci√≥n con #{otherParty.name}
            a.btn.btn-outline-secondary.btn-sm(href="/messages")
              i.bi.bi-arrow-left.me-1
              | Volver

        if error
          .alert.alert-danger= error

        // Messages Thread
        .card.shadow-sm
          .card-body(style="max-height: 500px; overflow-y: auto;")
            each msg in messages
              - const isSentByMe = msg.senderId === userId
              .mb-3(class=isSentByMe ? 'text-end' : '')
                .d-inline-block.p-3.rounded(
                  class=isSentByMe ? 'bg-primary text-white' : 'bg-light',
                  style="max-width: 75%;"
                )
                  if msg.itemTitle
                    .small.mb-2
                      i.bi.bi-box.me-1
                      em Re: #{msg.itemTitle}
                  if !isSentByMe
                    strong.d-block.mb-1= msg.senderName
                  p.mb-1= msg.messageText
                  small.text-muted(class=isSentByMe ? 'text-white-50' : '')
                    - const dateStr = new Date(msg.created).toLocaleString('es-EC', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
                    = dateStr

        // Reply Form
        .card.mt-3.shadow-sm
          .card-body
            h6.mb-3 Responder
            form(method="POST", action="/messages/new")
              input(type="hidden", name="receiverId", value=otherParty.id)
              input(type="hidden", name="subject", value=`Re: ${messages[0].subject}`)
              
              .mb-3
                label.form-label(for="body") Tu mensaje
                textarea.form-control(
                  id="body",
                  name="body",
                  rows="4",
                  required,
                  minlength="10",
                  maxlength="1000",
                  placeholder="Escribe tu respuesta..."
                )
                .form-text 10-1000 caracteres

              .d-grid
                button.btn.btn-primary(type="submit")
                  i.bi.bi-send.me-2
                  | Enviar Respuesta
