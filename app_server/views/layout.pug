doctype html
html
  head
    title= title
    link(rel='stylesheet', href='/stylesheets/style.css')
    link(href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css", rel="stylesheet")
    link(href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css", rel="stylesheet")
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js")
    if currentUser
      script.
        // Fetch unread message count on page load
        async function updateUnreadCount() {
          try {
            const response = await fetch('/api/messages/unread/count');
            const data = await response.json();
            const count = data.count || 0;
            const badge = document.getElementById('unreadBadge');
            if (badge) {
              if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'inline-block';
              } else {
                badge.style.display = 'none';
              }
            }
          } catch (err) {
            console.error('Error fetching unread count:', err);
          }
        }
        
        // Update on page load
        document.addEventListener('DOMContentLoaded', updateUnreadCount);
        
        // Optionally poll every 30 seconds for real-time updates
        setInterval(updateUnreadCount, 30000);

  body
    nav.navbar.navbar-expand-lg.navbar-light.bg-light.border-bottom
      .container-fluid
        a.navbar-brand.fw-bold(href="/") 
          i.bi.bi-arrow-repeat.me-2
          | CampuSwap
        
        button.navbar-toggler(type="button", data-bs-toggle="collapse", data-bs-target="#navbarNav")
          span.navbar-toggler-icon
        
        .collapse.navbar-collapse#navbarNav
          ul.navbar-nav.me-auto
            li.nav-item
              a.nav-link(href="/") Inicio
            li.nav-item
              a.nav-link(href="/items/new") Publicar
          
          ul.navbar-nav
            if currentUser
              li.nav-item
                a.nav-link(href="/me/items") Mis Items
              li.nav-item
                a.nav-link(href="/me/favorites") 
                  i.bi.bi-heart
                  | Favoritos
              li.nav-item
                a.nav-link.position-relative(href="/messages")
                  i.bi.bi-envelope
                  | Mensajes
                  span#unreadBadge.position-absolute.top-0.start-100.translate-middle.badge.rounded-pill.bg-danger(style="display: none;") 0
              li.nav-item.dropdown
                a#userDropdown.nav-link.dropdown-toggle(href="#", role="button", data-bs-toggle="dropdown", aria-expanded="false")
                  i.bi.bi-person-circle.me-1
                  | #{currentUser.name}
                ul.dropdown-menu.dropdown-menu-end(aria-labelledby="userDropdown")
                  li
                    a.dropdown-item(href="/auth/logout") Cerrar sesión
            else
              li.nav-item
                a.nav-link(href="/auth/login") Iniciar Sesión
              li.nav-item
                a.btn.btn-outline-primary.ms-2(href="/auth/register") Registrarse

    main.container-fluid.px-0
      block content

    footer.bg-light.py-4.mt-5
      .container-fluid.text-center.text-muted
        p &copy; 2025 CampuSwap - Mercado de segunda mano USFQ